<template id="page_template">
    <div class="mt-3">
        <h1>Kashi Lending</h1>
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h4>Add Kashi Lending Pair</h4>
                        <div class="form-group">
                            <label for="collateralSelect">Collateral (long)</label>
                            <select class="form-control" id="collateralSelect" v-model="newCollateral">
                                <option v-for="asset in assets" :value="asset">{{ asset.symbol }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assetSelect">Asset to borrow (short)</label>
                            <select class="form-control" id="assetSelect" v-model="newAsset">
                                <option v-for="asset in assets" :value="asset">{{ asset.symbol }}</option>
                            </select>
                        </div>
                        <div v-if="web3.peggedoracle">
                            <div class="form-group">
                                <label>Exchange Rate</label>
                                <input class="form-control" type="number" v-model="rate">
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" @click='create'>Create Lending Pair</button>                            
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="manager.web3.faucet.address" class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h4>Faucet</h4>
                        <p>To get some tokens to play with, use the faucet...</p>
                        <p>
                            You'll receive a bunch of tokens to play with.
                        </p>
                        <button class="btn btn-primary mt-3" @click="drip">Gimme, gimme, gimme!</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    app.page = {
        props: ["web3", "manager", "address", "block", "assets"],
        data: function () {
            return {
                newCollateral: "",
                newAsset: "",
                rate: 1
            };
        },
        mounted: async function() {
        },
        computed: {
        },
        methods: {
            create: async function () {
                console.log("CREATE")
                const exchangeRate = Decimal(this.rate).toInt(this.newCollateral.decimals + 18n - this.newAsset.decimals)
                console.log(exchangeRate.toString())
                const oracleData = await this.web3.peggedoracle.getDataParameter(exchangeRate).call()
                const kashiData = await this.web3.kashipair.getInitData(this.newCollateral.address, this.newAsset.address, this.web3.peggedoracle.address, oracleData).call()
                await this.web3.bentobox.deploy(this.web3.kashipair.address, kashiData, true).send({ from: this.address })
            },
            drip: async function () {
                await this.web3.faucet.drip().send({ from: this.address });
            },
        },
    };
    page_done();
</script>
