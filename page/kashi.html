<template id="page_template">
    <div class="mt-3">
        <h1>Kashi Lending</h1>
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h4>Pairs</h4>
                        <table class="table w-100 mb-0">
                            <thead>
                                <th>Collateral</th>
                                <th>Asset</th>
                                <th>Oracle</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Utilization</th>
                                <th class="text-right">Supply APR</th>
                                <th class="text-right">Borrow APR</th>
                            </thead>
                            <template v-for="pair in pairsChecked" v-if="pair.checked">
                                <tr style="cursor: pointer;" data-toggle="collapse" :data-target="'.kashi' + pair.address">
                                    <td v-if="pair.collateral">{{ pair.collateral.symbol }}</td>
                                    <td v-if="pair.asset">{{ pair.asset.symbol }}</td>
                                    <td>{{ pair.oracleName }}</td>
                                    <td class="text-right">
                                        {{ pair.oracleExchangeRate.print(pair.collateral.decimals + 18n - pair.asset.decimals, 1) }}<br>
                                        {{ pair.currentExchangeRate.print(pair.collateral.decimals + 18n - pair.asset.decimals, 1) }}
                                    </td>
                                    <td class="text-right">{{ pair.utilization.print(16, 2) }}%</td>
                                    <td class="text-right">{{ pair.supplyAPR.print(16, 2) }}%</td>
                                    <td class="text-right">{{ pair.interestPerYear.print(16, 2) }}%</td>
                                </tr>
                                <tr :class="'collapse kashi' + pair.address" style="background-color: #eeeeee">
                                    <td colspan="7">
                                        <div v-if="!pair.currentExchangeRate" :class="'mx-3 kashi' + pair.address">
                                            The exchange rate has not been initialized yet on this pair. Depending on the oracle you may have to update more than once with some time inbetween.<br>
                                            <button type="button" class="btn btn-sm btn-primary mt-3" @click="updateExchangeRate(pair)">Update Exchange Rate</button>
                                        </div>
                                        <div v-else="" :class="'mx-3 mb-3 kashi' + pair.address">
                                            TotalCollateral share: {{ pair.totalCollateralShare }}<br>
                                            TotalAsset ratio (share : fraction): {{ pair.totalAsset.elastic }} : {{ pair.totalAsset.base }}<br>
                                            TotalBorrow ratio (share : part): {{ pair.totalBorrow.elastic }} : {{ pair.totalBorrow.base }}<br>
                                            <br>
                                            Total collateral: {{ pair.totalCollateralAmount.print(pair.collateral.decimals, 2) }} {{ pair.collateral.symbol }}<br>
                                            Total assets: {{ (pair.totalAssetAmount + pair.currentBorrowAmount).print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            Total borrowed: {{ pair.currentBorrowAmount.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            <br>
                                            User assets fraction: {{ pair.userAssetFraction.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            User assets share: {{ pair.userAssetShare.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            <br>

                                            User collateral: {{ pair.userCollateralAmount.print(pair.asset.decimals) }} {{ pair.collateral.symbol }}<br>
                                            User assets: {{ pair.userAssetAmount.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            User assets from borrows: {{ pair.userAssetAmountFromBorrows.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            User assets total: {{ (pair.userAssetAmount + pair.userAssetAmountFromBorrows).print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            User borrowed: {{ pair.currentUserBorrowAmount.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            <br>
                                            Fee fractions: {{ pair.accrueInfo.feesEarnedFraction }}<br>
                                            Fee shares: {{ pair.feeAssetShare }}<br>
                                            Fee assets: {{ pair.feeAssetAmount.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            Fee assets from borrows: {{ pair.feeAssetAmountFromBorrows.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            Fee assets accrued: {{ pair.feeAssetAmountAccrued.print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>
                                            Fee assets total: {{ (pair.feeAssetAmount + pair.feeAssetAmountFromBorrows + pair.feeAssetAmountAccrued).print(pair.asset.decimals) }} {{ pair.asset.symbol }}<br>

                                            <div v-if="pair.userBentoCollateralAmount">
                                                <h5 class="card-title">Add Collateral</h5>
                                                <p>You have {{ pair.userBentoCollateralAmount.print(pair.collateral.decimals, 0) }} {{ pair.collateral.symbol }} in the BentoBox.</p>
                                                <div class="input-group" style="max-width: 350px;">
                                                    <input class="form-control" type="number" v-model="addCollateralAmount">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text" style="cursor: pointer;" @click="addCollateralAmount = pair.userBentoCollateralAmount.toDec(pair.collateral.decimals)">Max</span>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-primary ml-2" @click='addCollateral(pair)' :disabled="!Number(addCollateralAmount)">Add Collateral</button>
                                                </div>
                                            </div>                                        
                                            <div v-if="pair.userBentoAssetAmount">
                                                <h5 class="card-title">Add Supply</h5>
                                                <p>You have {{ pair.userBentoAssetAmount.print(pair.asset.decimals, 0) }} {{ pair.asset.symbol }} in the BentoBox.</p>
                                                <div class="input-group" style="max-width: 350px;">
                                                    <input class="form-control" type="number" v-model="addAssetAmount">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text" style="cursor: pointer;" @click="addAssetAmount = pair.userBentoAssetAmount.toDec(pair.asset.decimals)">Max</span>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-primary ml-2" @click='addAsset(pair)' :disabled="!Number(addAssetAmount)">Add Supply</button>
                                                </div>
                                            </div>                                        
                                            <div v-if="pair.userCollateralShare">
                                                <h5 class="card-title">Borrow</h5>
                                                <div class="input-group" style="max-width: 350px;">
                                                    <input class="form-control" type="number" v-model="borrowAmount">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text" style="cursor: pointer;" @click="borrowAmount = 0">Max</span>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-primary ml-2" @click='borrow(pair)' :disabled="!Number(borrowAmount)">Borrow</button>
                                                </div>
                                            </div>                                        
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h4>Add Kashi Lending Pair</h4>
                        <div class="form-group">
                            <label for="collateralSelect">Collateral (long)</label>
                            <select class="form-control" id="collateralSelect" v-model="newCollateral">
                                <option v-for="asset in assets" :value="asset">{{ asset.symbol }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assetSelect">Asset to borrow (short)</label>
                            <select class="form-control" id="assetSelect" v-model="newAsset">
                                <option v-for="asset in assets" :value="asset">{{ asset.symbol }}</option>
                            </select>
                        </div>
                        <div v-if="web3.peggedoracle">
                            <div class="form-group">
                                <label>Exchange Rate</label>
                                <input class="form-control" type="number" v-model="rate">
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" @click='create'>Create Lending Pair</button>                            
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="manager.web3.faucet.address" class="col-12 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h4>Faucet</h4>
                        <p>To get some tokens to play with, use the faucet...</p>
                        <p>
                            You'll receive a bunch of tokens to play with.
                        </p>
                        <button class="btn btn-primary mt-3" @click="drip">Gimme, gimme, gimme!</button>

                        <h4>Approve</h4>
                        <button type="button" class="btn btn-sm btn-primary" @click='approve'>Approve Kashi Lending</button>                            
                    </div>
                </div>
            </div>
        </div>

        <web3 :manager="manager" :poll="poll"></web3>
        <eventreader
            :manager="manager"
            address="0xb5891167796722331b7ea7824f036b3bdcb4531c"
            :topics="['0xd62166f3c2149208e51788b1401cc356bf5da1fc6c7886a32e18570f57d88b3b', '0x000000000000000000000000009e9cfad18132d9fb258984196191bdb6d58cff']"
            :handler="pair_handler"
            :output="pairs"
            :abi="abis.bentobox"
            :synced="pairs_synced"></eventreader>
    </div>
</template>
<script>
    // Functions that need accrue to be called
    const ACTION_ADD_ASSET = 1;
    const ACTION_REPAY = 2;
    const ACTION_REMOVE_ASSET = 3;
    const ACTION_REMOVE_COLLATERAL = 4;
    const ACTION_BORROW = 5;
    const ACTION_GET_REPAY_SHARE = 6;
    const ACTION_GET_REPAY_PART = 7;

    // Functions that don't need accrue to be called
    const ACTION_ADD_COLLATERAL = 10;

    // Function on BentoBox
    const ACTION_BENTO_DEPOSIT = 20;
    const ACTION_BENTO_WITHDRAW = 21;
    const ACTION_BENTO_TRANSFER = 22;
    const ACTION_BENTO_TRANSFER_MULTIPLE = 23;
    const ACTION_BENTO_SETAPPROVAL = 24;

    // Any external call (except to BentoBox)
    const ACTION_CALL = 30;

    class KashiCooker {
        constructor(pair, web3, userAddress) {
            this.web3 = web3
            this.pair = pair
            this.address = userAddress
            this.contract = this.web3.contract("kashipair", this.pair.address).methods

            this.actions = []
            this.values = []
            this.datas = []
        }

        async addCollateral(amountInput) {
            const amount = Decimal(amountInput).toInt(this.pair.collateral.decimals)
            const share = await this.web3.bentobox.toShare(this.pair.collateral.address, amount, true).call()

            this.actions.push(ACTION_ADD_COLLATERAL)
            this.values.push(0)
            this.datas.push(this.web3.eth.abi.encodeParameters(["int256", "address", "bool"], [share, this.address, false]))
            return this
        }

        async depositCollateral(amountInput) {
            // TODO: WETH
            const amount = Decimal(amountInput).toInt(this.pair.collateral.decimals)

            this.actions.push(ACTION_BENTO_DEPOSIT, ACTION_ADD_COLLATERAL)
            this.values.push(0, 0)
            this.datas.push(
                this.web3.eth.abi.encodeParameters(["address", "address", "int256", "int256"], [this.pair.collateral.address, this.address, amount, 0]),
                this.web3.eth.abi.encodeParameters(["int256", "address", "bool"], [-2, this.address, false])
            )
            return this
        }

        async cook() {
            return this.contract.cook(
                this.actions,
                this.values,
                this.datas
            ).send({ from: this.address })
        }
    }

    function takeFee(amount) {
        return amount * 10n / 11n
    }

    function toElastic(base, rebaseObj) {
        return rebase(base, rebaseObj.base, rebaseObj.elastic)
    }

    function toBase(base, rebaseObj) {
        return rebase(base, rebaseObj.elastic, rebaseObj.base)
    }

    app.page = {
        props: ["web3", "manager", "address", "block", "assets", "time"],
        data: function () {
            return {
                newCollateral: "",
                newAsset: "",
                rate: 1,
                pairs: [],
                addCollateralAmount: "",
                addAssetAmount: "",
                borrowAmount: ""
            };
        },
        mounted: async function() {
        },
        computed: {
            pairsChecked: function() {
                return this.pairs.filter(pair => pair.checked && pair.collateral && pair.asset).map(pair => {
                    objAssign(pair, {
                        interestPerYear: pair.accrueInfo.interestPerSecond * 60n * 60n * 24n * 365n,

                        totalCollateralAmount:  pair.collateral.toAmount(pair.totalCollateralShare),
                        totalAssetAmount: pair.asset.toAmount(pair.totalAsset.elastic),
                        currentBorrowAmount: pair.totalBorrow.elastic + pair.accrue(pair.totalBorrow.elastic),

                        userBentoCollateralAmount: pair.collateral.toAmount(pair.collateral.bentoBalance),
                        userBentoAssetAmount: pair.asset.toAmount(pair.asset.bentoBalance),

                        userCollateralAmount: pair.collateral.toAmount(pair.userCollateralShare),
                        userAssetShare: toElastic(pair.userAssetFraction, pair.totalAsset),
                        userBorrowAmount: toElastic(pair.userBorrowPart, pair.totalBorrow),

                        feeAssetShare: toElastic(pair.accrueInfo.feesEarnedFraction, pair.totalAsset),
                    })

                    objAssign(pair, {
                        utilization: pair.currentBorrowAmount ? pair.currentBorrowAmount * 1000000000000000000n / (pair.totalAssetAmount + pair.currentBorrowAmount) : 0n,
                        userAssetAmount: pair.asset.toAmount(pair.userAssetShare),
                        userAssetAmountFromBorrows: rebase(pair.userAssetFraction, pair.totalAsset.base, pair.currentBorrowAmount),
                        currentUserBorrowAmount: pair.userBorrowAmount + takeFee(pair.accrue(pair.userBorrowAmount)),

                        feeAssetAmount: pair.asset.toAmount(pair.feeAssetShare),
                        feeAssetAmountFromBorrows: rebase(pair.accrueInfo.feesEarnedFraction, pair.totalAsset.base, pair.currentBorrowAmount),
                        feeAssetAmountAccrued: pair.accrue(pair.totalBorrow.elastic) * 1n / 11n,
                    })

                    return objAssign(pair, {
                        supplyAPR: takeFee(pair.interestPerYear * pair.utilization) / 1000000000000000000n
                    })
                })
            }
        },
        methods: {
            pair_handler: async function(log, web3, row, decoded) {
                let deployParams = web3.decode.kashipair.decodeMethod(
                    "0x247fd03c" + (decoded.data ? decoded.data.substr(2) : "")
                ).params;
                let oracleName = ""
                if (deployParams[2].value.toLowerCase() == this.web3.peggedoracle.address.toLowerCase()) {
                    oracleName = "Pegged"
                    oracleDescription = "The exchangeRate is fixed and will never change."
                }
                if (!oracleName) { return }

                return {
                    address: decoded.cloneAddress,
                    collateralAddress: deployParams[0].value,
                    assetAddress: deployParams[1].value,
                    oracle: deployParams[2].value,
                    oracleData: deployParams[3].value,
                    oracleName: oracleName,
                    oracleDescription: oracleDescription
                }
            },
            pairs_synced: async function() {
                this.pairs.forEach(pair => {
                    objAssign(pair, {
                        collateral: app.assetManager.addAsset({ address: pair.collateralAddress }),
                        asset: app.assetManager.addAsset({ address: pair.assetAddress }),
                        accrue: function(amount) {
                            return ((amount * this.accrueInfo.interestPerSecond * (app.time / 1000n - this.accrueInfo.lastAccrued)) / 1000000000000000000n)
                        }
                    })
                })
                await this.poll()
            },
            poll: async function() {
                if (this.pairs.length) {
                    const kashiInfo = rpcToObj(await this.web3.boringhelper.pollKashiPairs(this.address, this.pairs.map(pair => pair.address)).call());
                    kashiInfo.forEach((pair, i) => objAssign(this.pairs[i], pair))
                    this.pairs.forEach(pair => {
                        objAssign(pair, {
                            checked: true
                        })
                    })
                }
            },
            create: async function () {
                console.log("CREATE")
                const exchangeRate = Decimal(this.rate).toInt(this.newCollateral.decimals + 18n - this.newAsset.decimals)
                console.log(exchangeRate.toString())
                const oracleData = await this.web3.peggedoracle.getDataParameter(exchangeRate).call()
                const kashiData = await this.web3.kashipair.getInitData(this.newCollateral.address, this.newAsset.address, this.web3.peggedoracle.address, oracleData).call()
                await this.web3.bentobox.deploy(this.web3.kashipair.address, kashiData, true).send({ from: this.address })
            },
            drip: async function () {
                await this.web3.faucet.drip().send({ from: this.address })
            },
            updateExchangeRate: async function(pair) {
                await this.web3.contract("kashipair", pair.address).methods.updateExchangeRate().send({ from: this.address })
            },
            addCollateral: async function (pair) {
                const cooker = new KashiCooker(pair, this.web3, this.address)
                await cooker.addCollateral(this.addCollateralAmount)
                await cooker.cook()
                
                /*const amount = Decimal(this.addCollateralAmount).toInt(pair.collateral.decimals)
                const share = await this.web3.bentobox.toShare(pair.collateral.address, amount, true).call()
                await this.web3.contract("kashipair", pair.address).methods.addCollateral(this.address, false, share).send({ from: this.address })*/
            },
            addAsset: async function (pair) {
                const amount = Decimal(this.addAssetAmount).toInt(pair.asset.decimals)
                const share = await this.web3.bentobox.toShare(pair.asset.address, amount, true).call()
                await this.web3.contract("kashipair", pair.address).methods.addAsset(this.address, false, share).send({ from: this.address })
            },
            borrow: async function (pair) {
                const amount = Decimal(this.borrowAmount).toInt(pair.asset.decimals)
                await this.web3.contract("kashipair", pair.address).methods.borrow(this.address, amount).send({ from: this.address })
            },
            approve: async function () {
                await this.web3.bentobox.setMasterContractApproval(this.address, this.web3.kashipair.address, true, 0, "0x", "0x").send({ from: this.address })
            }
        },
    };
    page_done();
</script>
