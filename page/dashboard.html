<template id="page_template">
    <div class="mt-3">
        <div class="row">
            <div class="col-12 mb-5 mx-auto" style="max-width: 720px" v-for="(items, handler) in groupedAssets">
                <div
                    :is="handler"
                    :assets="items"
                    :app="app"
                    :manager="manager"
                    :address="address"
                    :web3="web3"
                    :key="handler"
                ></div>
            </div>
            <div class="col-12 mx-auto" style="max-width: 720px">
                <h3>Vested Sushi</h3>
                <web3 :manager="manager" :poll="poll"></web3>
                <eventreader
                    :manager="manager"
                    address="0x6b3595068778dd592e39a122f4f5a5cf09c90fe2"
                    :topics="['0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef', '0xc2EdaD668740f1aA35E4D8f227fB8E17dcA888Cd', address]"
                    :handler="harvest_handler"
                    :output="harvests"
                    :abi="abis.sushi"
                >
                    <div class="text-center mb-3">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </eventreader>
                <div class="jumbotron">
                    This is experimental, these number may not be correct.<br />
                    <br />
                    Your pending SUSHI at lockup start: {{ pendingSushiAtStart.print(18, 4) }}<br />
                    Your currently pending SUSHI: {{ app.pendingSushi.print(18, 4) }}<br />
                    Your harvested SUSHI since lockup: {{ harvestedSushi.print(18, 4) }}<br />
                    <br />
                    Estimated in lockup: {{ ((app.pendingSushi - pendingSushiAtStart + harvestedSushi) * 2n).print(18, 4) }}
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    app.page = {
        props: ["manager", "web3", "address", "assets"],
        data: function () {
            return {
                harvests: [],
                pendingSushiAtStart: 0n,
            };
        },
        computed: {
            groupedAssets: function () {
                const groups = {};
                this.assets.forEach(asset => {
                    (groups[asset.handler] = groups[asset.handler] || []).push(asset);
                })
                return groups;
            },
            harvestedSushi: function () {
                return this.harvests.sum(0n);
            },
        },
        methods: {
            harvest_handler: function (log, web3, row, decoded) {
                if (row.block >= 10959148) {
                    return BigInt(decoded.value);
                }
            },
            poll: async function () {
                if (!this.addresslist) {
                    this.addresslist = await $.ajax("data/addresslist-vesting.json");
                }
                let info = this.addresslist.find((a) => a.address === this.address);
                this.pendingSushiAtStart = info ? BigInt(info.sushi) : 0n;

                /*let numberOfPools = await this.web3.chef.poolLength().call();
                let pids = [...Array(parseInt(numberOfPools)).keys()];
                let result = await this.web3.boringHelper.getPendingSushi(this.address, pids).call();
                this.pendingSushi = result[1].map((p) => BigInt(p.pendingSushi)).sum(0n);*/
            },
        },
    };
    page_done();
</script>
